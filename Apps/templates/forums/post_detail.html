{% extends 'base/base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container">
    <div class="row-no-gutters">
        <h1>{{ object.title }}</h1>
    </div>
    <div class="row">
        <p>Category: {{ object.sub_forum.category.category }}</p>
        <p>{{ object.posted_by }}</p>
        <p>{{ object.posted_date }}</p>
    </div>
    <div class="row no-gutters mb-5">
        <div class="col-6">
            <p>{{ object.description }}</p>
        </div>
        <div class="col-6">
            <img src="{{ object.media.url }}" style="max-width: 200px">
        </div>
    </div>
    <div class="mb-5">
        <form method="POST">
            {% csrf_token %}
            {{ form.as_table }}
            <input type="submit" class="btn btn-info" value="post comment" style="margin-left: 20px">
        </form>
    </div>
    {% for comment, liked in comments %}
        <div class="container">
            <div class="card m-3">
                <p>{{ comment.posted_by }}</p>
                <p>{{ comment.message }}</p>
                <p>{{ comment.posted_date }}</p>
                <p>This is a comment</p>
                {% if liked %}
                    <input type="button" class="like" name="{{ comment.pk }}" value="Dislike {{ comment.total_likes }}" />
                {% else %}
                    <input type="button" class="like" name="{{ comment.pk }}" value="Like {{ comment.total_likes }}" />
                {% endif %}
                <i class="fa fa-thumbs-up"></i>
                {% for reply in comment.replies.all %}
                    <p>{{ reply.posted_by }}</p>
                    <p>{{ reply.message }}</p>
                    <p>REPLY HERE</p>
                {% endfor %}
                <!--reply-->
                <form method="post">
                    {{ form.as_p }}
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <input class="btn btn-primary" type="submit" value="Reply">
                </form>
            </div>
        </div>
    {% endfor %}
    {% if object.posted_by == user %}
    <div>
        <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{% url 'post-update' object.id %}">Edit</a>
        <a class="btn btn-danger btn-sm mt-1 mb-1" href="{% url 'post-delete' object.id %}">Delete</a>
    </div>
    {% endif %}
</div>
{% endblock content %}
{% block javascript %}
    <script type="text/javascript">
        $(document).ready(function() {


            $(".like").click(function () {
                let $thisComment = $(this);
                $.ajax({
                    type: "POST",
                    url: "{% url 'comment-like' %}",
                    data: {'slug': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
                   dataType: "json",
                   success: function(response) {
                        $thisComment.val(response.message + " " + response.likes);
                    },
                    error: function(rs, e) {
                           alert('error!');
                    }
                });
            });


        });
    </script>
{% endblock javascript %}